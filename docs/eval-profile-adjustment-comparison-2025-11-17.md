# プロファイル調整前後の比較評価

**日付**: 2025-11-17  
**調整内容**: implブースト削減、docペナルティ緩和、limit削減  
**関連Issue**: [#77](https://github.com/CAPHTECH/kiri/issues/77)

## エグゼクティブサマリー

プロファイル設定を微調整した結果、**F1スコアの悪化が約50%改善**しました（-0.09 → -0.04）。Precisionが大幅に改善し、Recallとのバランスが向上しました。

### 主要な改善点

✅ **F1スコアの悪化が縮小**

- 調整前: -0.087 ～ -0.101 (28～33%低下)
- 調整後: -0.041 (13%低下) ✨ **約50%改善**

✅ **Precisionの大幅改善**

- 調整前: 0.125 ～ 0.133 (baseline: 0.217)
- 調整後: 0.173 (baseline: 0.217) ✨ **+30%改善**

✅ **Precision/Recallのバランス改善**

- 調整前: Precision -40%, Recall +15%（不均衡）
- 調整後: Precision -20%, Recall +11%（バランス改善）

---

## 詳細比較

### 調整内容

| パラメータ           | 調整前   | 調整後    | 変更理由                  |
| -------------------- | -------- | --------- | ------------------------- |
| **impl boost**       | 1.3～1.5 | 1.2～1.25 | implブーストが強すぎた    |
| **doc penalty**      | 0.5      | 0.65～0.7 | docペナルティが厳しすぎた |
| **limit**            | 10       | 7         | ノイズ混入を削減          |
| **path multipliers** | 1.3～1.8 | 1.2～1.5  | 過度なブーストを削減      |

---

### 性能比較マトリクス

#### 調整前（V1: limit=10）

| Profile     | P@5       | R@5       | F1@5      | vs default |
| ----------- | --------- | --------- | --------- | ---------- |
| **default** | **0.217** | **0.542** | **0.310** | -          |
| testfail    | 0.133     | 0.667     | 0.222     | -0.087 ❌  |
| typeerror   | 0.133     | 0.667     | 0.222     | -0.087 ❌  |
| bugfix      | 0.129     | 0.646     | 0.215     | -0.094 ❌  |
| debug       | 0.129     | 0.646     | 0.215     | -0.094 ❌  |
| api         | 0.129     | 0.646     | 0.215     | -0.094 ❌  |
| editor      | 0.129     | 0.646     | 0.215     | -0.094 ❌  |
| feature     | 0.125     | 0.625     | 0.208     | -0.101 ❌  |

**サマリー:**

- F1低下: -0.087 ～ -0.101
- Precision低下: -39% ～ -42%
- Recall改善: +15% ～ +23%

---

#### 調整後（V2: limit=7）

| Profile     | P@5       | R@5       | F1@5      | vs default |
| ----------- | --------- | --------- | --------- | ---------- |
| **default** | **0.217** | **0.542** | **0.310** | -          |
| feature     | 0.173     | 0.604     | 0.269     | -0.041 ⚠️  |
| bugfix      | 0.173     | 0.604     | 0.269     | -0.041 ⚠️  |
| debug       | 0.173     | 0.604     | 0.269     | -0.041 ⚠️  |
| api         | 0.173     | 0.604     | 0.269     | -0.041 ⚠️  |
| editor      | 0.173     | 0.604     | 0.269     | -0.041 ⚠️  |
| testfail    | 0.173     | 0.604     | 0.269     | -0.041 ⚠️  |
| typeerror   | 0.173     | 0.604     | 0.269     | -0.041 ⚠️  |

**サマリー:**

- F1低下: -0.041 ✨ **約50%改善**
- Precision低下: -20% ✨ **大幅改善**
- Recall改善: +11% （バランス改善）

---

### 改善度の可視化

```
F1スコア悪化の改善:
調整前: ████████████████████ -0.101 (最悪)
調整後: ██████████           -0.041 (50%改善)
目標:   ═══════════════════  +0.000 (baseline維持)

Precision改善:
調整前: ████████             0.125 (-42%)
調整後: █████████████        0.173 (-20%)  ✨ +30%改善
目標:   ████████████████████ 0.217 (baseline)

Recall:
調整前: ████████████████████ 0.667 (+23%)
調整後: ███████████████████  0.604 (+11%)
目標:   ██████████████       0.542 (baseline)
```

---

## 要因分析

### なぜ改善したか

1. **implブーストの削減（1.3～1.5 → 1.2～1.25）**
   - 関連性の低い実装ファイルが上位に来なくなった
   - Precisionが改善

2. **docペナルティの緩和（0.5 → 0.65～0.7）**
   - 有用なドキュメントファイルが適度に含まれるようになった
   - 関連性の判定が改善

3. **limitの削減（10 → 7）**
   - ノイズの混入が減少
   - Precisionが改善

4. **path multipliersの穏やか化**
   - 特定パスへの過度な偏りが減少
   - バランスの取れたランキング

### なぜまだbaselineに及ばないか

- **limit=7はlimit=5より多い**
  - defaultはlimit=5で厳選している
  - 7個返すとまだノイズが混入
- **implブーストが効きすぎる場面がある**
  - 一部のクエリでは実装ファイルよりドキュメントが適切

---

## 次のアクション

### さらなる改善案（優先度順）

#### 1. limit=6でテスト

```bash
# limitを6に調整して再テスト
pnpm run assay:profile-matrix
```

- Precisionをさらに改善できる可能性
- limit=5（default）に近づける

#### 2. クエリカテゴリ別の分析

```bash
# データセットのクエリをカテゴリ別に分析
# bugfix, feature, testfailなどで性能差を確認
```

- カテゴリごとに最適なプロファイルが異なる可能性

#### 3. 動的プロファイル選択

- クエリの意図を分類（"test failed" → testfailプロファイル）
- ハイブリッドアプローチでF1向上

#### 4. より大規模なデータセット

- 現在24クエリ → 50～100クエリに拡張
- 統計的検出力を向上

---

## 結論

**プロファイル調整は成功しました。**

- F1スコア悪化が約50%改善（-0.09 → -0.04）
- Precisionが30%改善（0.13 → 0.17）
- Recallとのバランスが改善

**現状:**

- `default`プロファイルが依然として最良（F1=0.310）
- 新プロファイル（F1=0.269）は改善したが、まだ届かず

**次のステップ:**

1. limit=6でさらなる改善を試す
2. クエリカテゴリ別の最適化
3. より大規模なデータセットでの検証

Issue #77の目標（P@5: 0.26 → 0.30-0.35）達成に向けて、着実に前進しています。

---

## 技術詳細

### 調整パラメータ一覧

#### feature プロファイル

```typescript
// 調整前
impl: 1.5, doc: 0.5, limit: 10

// 調整後
impl: 1.25, doc: 0.65, limit: 7
```

#### bugfix プロファイル

```typescript
// 調整前
impl: 1.4, doc: 0.5, limit: 10

// 調整後
impl: 1.2, doc: 0.65, limit: 7
```

#### testfail プロファイル

```typescript
// 調整前
impl: 1.3, doc: 0.5, limit: 10
pathMultipliers: tests/ 1.8

// 調整後
impl: 1.2, doc: 0.65, limit: 7
pathMultipliers: tests/ 1.5
```

---

## 参考資料

- 調整前レポート: `var/assay/profile-matrix-2025-11-17-v1.md`
- 調整後レポート: `var/assay/profile-matrix-2025-11-17-v2.md`
- 初回評価文書: `docs/eval-profile-systematic-testing-2025-11-17.md`
- 関連Issue: [#77](https://github.com/CAPHTECH/kiri/issues/77)
