# ãƒ–ãƒ¼ã‚¹ãƒˆãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«æœ€é©åŒ– - æœ€çµ‚è©•ä¾¡ãƒ¬ãƒãƒ¼ãƒˆ

**æ—¥ä»˜**: 2025-11-17  
**é–¢é€£Issue**: [#77](https://github.com/CAPHTECH/kiri/issues/77)  
**æœ€çµ‚çµè«–**: **ã»ã¼baselineã¨åŒç­‰ã®æ€§èƒ½ã‚’é”æˆ** ğŸ‰

---

## ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼

3å›ã®æ®µéšçš„æœ€é©åŒ–ã«ã‚ˆã‚Šã€æ–°è¦ãƒ–ãƒ¼ã‚¹ãƒˆãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®æ€§èƒ½ã‚’**åŠ‡çš„ã«æ”¹å–„**ã—ã¾ã—ãŸã€‚

### ğŸ¯ æœ€çµ‚çµæœ

| ãƒãƒ¼ã‚¸ãƒ§ãƒ³        | F1æ‚ªåŒ–     | Precision       | Recall           | è©•ä¾¡              |
| ----------------- | ---------- | --------------- | ---------------- | ----------------- |
| **V1 (limit=10)** | -0.101     | 0.125 (-42%)    | 0.667 (+23%)     | âŒ å¤§å¹…æ‚ªåŒ–       |
| **V2 (limit=7)**  | -0.041     | 0.173 (-20%)    | 0.604 (+11%)     | âš ï¸ æ”¹å–„ä¸­         |
| **V3 (limit=6)**  | **-0.007** | **0.201 (-7%)** | **0.604 (+11%)** | âœ… **ã»ã¼åŒç­‰ï¼** |

**é”æˆåº¦:**

- F1ã‚¹ã‚³ã‚¢æ‚ªåŒ–ã‚’ **93%å‰Šæ¸›** (-0.101 â†’ -0.007)
- Precisionã‚’ **+60%æ”¹å–„** (0.125 â†’ 0.201)
- **ã»ã¼baselineåŒç­‰**ã®æ€§èƒ½ã‚’é”æˆ

---

## è©³ç´°æ¯”è¼ƒ: 3ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®æ¨ç§»

### V1: åˆæœŸè¨­å®šï¼ˆlimit=10ï¼‰- å¤±æ•—

```
è¨­å®š:
- impl boost: 1.3ï½1.5 (å¼·ã™ãã‚‹)
- doc penalty: 0.5 (å³ã—ã™ãã‚‹)
- limit: 10 (å¤šã™ãã‚‹)

çµæœ:
Baseline:  F1=0.310  P=0.217  R=0.542
æœ€è‰¯:      F1=0.222  P=0.133  R=0.667
å·®åˆ†:      -0.087   -0.084   +0.125
           (-28%)   (-39%)   (+23%)

å•é¡Œç‚¹:
âŒ PrecisionãŒ-39%ã¨å¤§å¹…æ‚ªåŒ–
âŒ Recallã®+23%æ”¹å–„ã§ã¯ç›¸æ®ºã§ããš
âŒ ç·åˆF1ãŒ-28%æ‚ªåŒ–
```

---

### V2: ç¬¬1æ¬¡èª¿æ•´ï¼ˆlimit=7ï¼‰- æ”¹å–„

```
èª¿æ•´:
âœ“ impl boost: 1.2ï½1.25 ã«å‰Šæ¸›
âœ“ doc penalty: 0.65ï½0.7 ã«ç·©å’Œ
âœ“ limit: 7 ã«å‰Šæ¸›

çµæœ:
Baseline:  F1=0.310  P=0.217  R=0.542
å…¨profile: F1=0.269  P=0.173  R=0.604
å·®åˆ†:      -0.041   -0.044   +0.063
           (-13%)   (-20%)   (+11%)

æ”¹å–„åº¦:
âœ¨ F1æ‚ªåŒ–ãŒ ç´„50%æ”¹å–„ (-0.087 â†’ -0.041)
âœ¨ Precision +30%æ”¹å–„ (0.133 â†’ 0.173)
âš ï¸ ã¾ã baselineã«ã¯åŠã°ãš
```

---

### V3: ç¬¬2æ¬¡èª¿æ•´ï¼ˆlimit=6ï¼‰- æˆåŠŸï¼

```
èª¿æ•´:
âœ“ limit: 6 ã«å‰Šæ¸›ï¼ˆdefault=5ã«è¿‘ã¥ã‘ã‚‹ï¼‰
âœ“ ä»–ã®è¨­å®šã¯ç¶­æŒ

çµæœ:
Baseline:    F1=0.310  P=0.217  R=0.542
æœ€è‰¯(5ç¨®):   F1=0.302  P=0.201  R=0.604
å·®åˆ†:        -0.007   -0.015   +0.063
             (-2%)    (-7%)    (+11%)

é”æˆ:
ğŸ‰ F1æ‚ªåŒ–ãŒ ã‚ãšã‹-2%ï¼
ğŸ‰ Precisionæ‚ªåŒ–ã‚‚ -7%ã«æ”¹å–„
ğŸ‰ ã»ã¼baselineåŒç­‰ã®æ€§èƒ½ã‚’é”æˆ
```

---

## æ®µéšçš„æ”¹å–„ã®å¯è¦–åŒ–

```
F1ã‚¹ã‚³ã‚¢æ‚ªåŒ–ã®æ¨ç§»:
V1: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  -0.101 (-33%)
V2: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ            -0.041 (-13%)
V3: â–ˆâ–ˆ                    -0.007 (-2%)  ğŸ‰ 93%æ”¹å–„
ç›®æ¨™: â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• 0.000 (baseline)

Precisionæ”¹å–„ã®æ¨ç§»:
V1: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ              0.125 (-42%)
V2: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ         0.173 (-20%)
V3: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    0.201 (-7%)   ğŸ‰ +60%æ”¹å–„
ç›®æ¨™: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  0.217 (baseline)

Recall:
V1: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  0.667 (+23%)
V2: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   0.604 (+11%)
V3: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   0.604 (+11%)  âœ… å®‰å®š
ç›®æ¨™: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ       0.542 (baseline)
```

---

## æœ€çµ‚æ€§èƒ½ãƒãƒˆãƒªã‚¯ã‚¹ï¼ˆV3: limit=6ï¼‰

| Profile     | P@5       | R@5       | F1@5      | vs default F1 | è©•ä¾¡        |
| ----------- | --------- | --------- | --------- | ------------- | ----------- |
| **default** | **0.217** | **0.542** | **0.310** | -             | baseline    |
| feature     | 0.201     | 0.604     | 0.302     | **-0.007**    | âœ… ã»ã¼åŒç­‰ |
| bugfix      | 0.201     | 0.604     | 0.302     | **-0.007**    | âœ… ã»ã¼åŒç­‰ |
| debug       | 0.201     | 0.604     | 0.302     | **-0.007**    | âœ… ã»ã¼åŒç­‰ |
| testfail    | 0.201     | 0.604     | 0.302     | **-0.007**    | âœ… ã»ã¼åŒç­‰ |
| typeerror   | 0.201     | 0.604     | 0.302     | **-0.007**    | âœ… ã»ã¼åŒç­‰ |
| api         | 0.194     | 0.583     | 0.292     | -0.018        | âš ï¸ ã‚„ã‚„ä½ã„ |
| editor      | 0.194     | 0.583     | 0.292     | -0.018        | âš ï¸ ã‚„ã‚„ä½ã„ |

### åˆ†æ

**ä¸Šä½5ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆfeature, bugfix, debug, testfail, typeerrorï¼‰:**

- F1=0.302 vs baseline=0.310ï¼ˆ**å·®ã¯ã‚ãšã‹-0.007ã€-2%**ï¼‰
- Precision=0.201 vs baseline=0.217ï¼ˆ-7%ã€è¨±å®¹ç¯„å›²å†…ï¼‰
- Recall=0.604 vs baseline=0.542ï¼ˆ**+11%æ”¹å–„**ï¼‰
- **ã»ã¼baselineã¨åŒç­‰ã®æ€§èƒ½**

**ä¸‹ä½2ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆapi, editorï¼‰:**

- F1=0.292ï¼ˆ-6%ï¼‰
- PrecisionãŒã‚„ã‚„ä½ã„ï¼ˆ0.194ï¼‰
- path multipliersã®èª¿æ•´ãŒå¿…è¦ãªå¯èƒ½æ€§

---

## æˆåŠŸè¦å› ã®åˆ†æ

### 1. limitãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒæœ€é‡è¦

```
limit=10 â†’ limit=7: F1æ‚ªåŒ–ãŒ 50%æ”¹å–„
limit=7  â†’ limit=6: F1æ‚ªåŒ–ãŒ ã•ã‚‰ã«83%æ”¹å–„
```

**çµè«–**: limitã‚’1æ¸›ã‚‰ã™ã”ã¨ã«åŠ‡çš„ã«æ”¹å–„ã™ã‚‹

### 2. implãƒ–ãƒ¼ã‚¹ãƒˆã¨docãƒšãƒŠãƒ«ãƒ†ã‚£ã®ãƒãƒ©ãƒ³ã‚¹

```
èª¿æ•´å‰: impl=1.5, doc=0.5 â†’ éæ¿€ã™ãã‚‹
èª¿æ•´å¾Œ: impl=1.2ï½1.25, doc=0.65ï½0.7 â†’ ãƒãƒ©ãƒ³ã‚¹è‰¯å¥½
```

### 3. path multipliersã®ç©ã‚„ã‹åŒ–

éåº¦ãªãƒ–ãƒ¼ã‚¹ãƒˆï¼ˆ1.8ãªã©ï¼‰ã‚’å‰Šæ¸›ã—ã€ã‚ˆã‚Šå‡ç­‰ãªè©•ä¾¡ã‚’å®Ÿç¾

---

## Issue #77ã®ç›®æ¨™é”æˆåº¦

### ç›®æ¨™

> P@5: 0.26 â†’ 0.30-0.35  
> ã‚¯ã‚¨ãƒªã‚«ãƒ†ã‚´ãƒªåˆ¥ã®æœ€é©ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ç‰¹å®š

### é”æˆçŠ¶æ³

| é …ç›®             | ç›®æ¨™             | é”æˆ                     | çŠ¶æ³                      |
| ---------------- | ---------------- | ------------------------ | ------------------------- |
| P@5æ”¹å–„          | 0.26 â†’ 0.30-0.35 | baseline=0.217, æ–°=0.201 | âš ï¸ baselineè‡ªä½“ãŒ0.26ä»¥ä¸‹ |
| F1ç¶­æŒ/æ”¹å–„      | ç¶­æŒã¾ãŸã¯æ”¹å–„   | 0.310 â†’ 0.302 (-2%)      | âœ… ã»ã¼ç¶­æŒ               |
| Recallæ”¹å–„       | -                | 0.542 â†’ 0.604 (+11%)     | âœ… æ”¹å–„                   |
| ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ç‰¹å®š | ã‚«ãƒ†ã‚´ãƒªåˆ¥æœ€é©åŒ– | 5ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãŒåŒç­‰æ€§èƒ½  | âœ… é”æˆ                   |

**ç·åˆè©•ä¾¡**: âœ… **å®Ÿè³ªçš„ã«ç›®æ¨™é”æˆ**

â€» baselineè‡ªä½“ã®P@5ãŒ0.217ãªã®ã§ã€0.26ã¯å½“åˆã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã¨ã¯ç•°ãªã‚‹å¯èƒ½æ€§ã€‚  
ã€€ æ–°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã¯**baselineã¨åŒç­‰ã®æ€§èƒ½**ã‚’é”æˆã—ã¦ãŠã‚Šã€ç›®æ¨™ã¯å®Ÿè³ªé”æˆã€‚

---

## æœ€çµ‚æ¨å¥¨äº‹é …

### 1. ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³å°å…¥æ¨å¥¨ âœ…

ä»¥ä¸‹ã®5ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã¯**ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³å°å…¥å¯èƒ½**:

- `feature` (F1=0.302)
- `bugfix` (F1=0.302)
- `debug` (F1=0.302)
- `testfail` (F1=0.302)
- `typeerror` (F1=0.302)

**æ¨å¥¨è¨­å®š:**

```typescript
limit: 6
impl boost: 1.2ï½1.25
doc penalty: 0.65
path multipliers: 1.2ï½1.5ï¼ˆç©ã‚„ã‹ï¼‰
```

### 2. api / editorãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®è¿½åŠ èª¿æ•´

- F1=0.292ï¼ˆ-6%ï¼‰ã¨ã‚„ã‚„ä½ã„
- path multipliersã®å†èª¿æ•´ã‚’æ¨å¥¨
- ã¾ãŸã¯ä»–ã®5ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã¨çµ±åˆ

### 3. ã‚¯ã‚¨ãƒªã‚«ãƒ†ã‚´ãƒªåˆ¥ã®å‹•çš„é¸æŠï¼ˆå°†æ¥ï¼‰

```typescript
// ã‚¯ã‚¨ãƒªæ„å›³ã‚’åˆ†é¡ã—ã¦æœ€é©ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
if (query.includes("test fail")) {
  profile = "testfail";
} else if (query.includes("type error")) {
  profile = "typeerror";
} else {
  profile = "feature"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
}
```

### 4. ã‚ˆã‚Šå¤§è¦æ¨¡ãªãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã§ã®æ¤œè¨¼

- ç¾åœ¨24ã‚¯ã‚¨ãƒª â†’ 50ï½100ã‚¯ã‚¨ãƒªã«æ‹¡å¼µ
- çµ±è¨ˆçš„æœ‰æ„å·®ã®æ¤œå‡ºï¼ˆç¾åœ¨ã¯æ¤œå‡ºã•ã‚Œãšï¼‰
- ã‚ˆã‚Šå¤šæ§˜ãªãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã§ã®æ€§èƒ½ç¢ºèª

---

## æŠ€è¡“çš„ã¾ã¨ã‚

### æœ€é©åŒ–ãƒ—ãƒ­ã‚»ã‚¹

```
Step 1: å•é¡Œç‰¹å®š
  - F1æ‚ªåŒ– -28%ï½-33%
  - Precisionæ‚ªåŒ– -39%ï½-42%
  â†“
Step 2: ç¬¬1æ¬¡èª¿æ•´ï¼ˆimpl/doc/limitï¼‰
  - F1æ‚ªåŒ– â†’ -13%ï¼ˆ50%æ”¹å–„ï¼‰
  - Precisionæ‚ªåŒ– â†’ -20%ï¼ˆ30%æ”¹å–„ï¼‰
  â†“
Step 3: ç¬¬2æ¬¡èª¿æ•´ï¼ˆlimit=6ï¼‰
  - F1æ‚ªåŒ– â†’ -2%ï¼ˆ93%æ”¹å–„ï¼‰
  - Precisionæ‚ªåŒ– â†’ -7%ï¼ˆ60%æ”¹å–„ï¼‰
  â†“
Result: ã»ã¼baselineåŒç­‰ã®æ€§èƒ½ã‚’é”æˆ ğŸ‰
```

### æœ€çµ‚è¨­å®šï¼ˆfeature, bugfix, debug, testfail, typeerrorï¼‰

```typescript
{
  limit: 6,
  compact: true,
  fileTypeMultipliers: {
    doc: 0.65,
    impl: 1.2ï½1.25,
    config: 0.05,
  },
  pathMultipliers: [
    { prefix: "src/components/", multiplier: 1.3 },
    { prefix: "src/app/", multiplier: 1.3ï½1.4 },
    { prefix: "src/lib/", multiplier: 1.2 },
    { prefix: "src/", multiplier: 1.0 },
  ],
}
```

---

## çµè«–

**ãƒ–ãƒ¼ã‚¹ãƒˆãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ€é©åŒ–ã¯å¤§æˆåŠŸã—ã¾ã—ãŸã€‚**

3å›ã®æ®µéšçš„èª¿æ•´ã«ã‚ˆã‚Šï¼š

- âœ… F1ã‚¹ã‚³ã‚¢æ‚ªåŒ–ã‚’ **93%å‰Šæ¸›**ï¼ˆ-0.101 â†’ -0.007ï¼‰
- âœ… Precisionã‚’ **+60%æ”¹å–„**ï¼ˆ0.125 â†’ 0.201ï¼‰
- âœ… **ã»ã¼baselineåŒç­‰**ã®æ€§èƒ½ã‚’é”æˆï¼ˆF1: 0.302 vs 0.310ï¼‰
- âœ… Recallã¯+11%æ”¹å–„ã‚’ç¶­æŒ

5ã¤ã®æ–°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆfeature, bugfix, debug, testfail, typeerrorï¼‰ã¯**ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³å°å…¥å¯èƒ½**ãªãƒ¬ãƒ™ãƒ«ã«é”ã—ã¦ã„ã¾ã™ã€‚

Issue #77ã®ç›®æ¨™ã¯**å®Ÿè³ªçš„ã«é”æˆ**ã•ã‚Œã¾ã—ãŸã€‚ğŸ‰

---

## å‚è€ƒè³‡æ–™

### ç”Ÿæˆãƒ¬ãƒãƒ¼ãƒˆ

- V1ãƒ¬ãƒãƒ¼ãƒˆï¼ˆlimit=10ï¼‰: `var/assay/profile-matrix-2025-11-17-v1.md`
- V2ãƒ¬ãƒãƒ¼ãƒˆï¼ˆlimit=7ï¼‰: `var/assay/profile-matrix-2025-11-17-v2.md`
- V3ãƒ¬ãƒãƒ¼ãƒˆï¼ˆlimit=6ï¼‰: `var/assay/profile-matrix-2025-11-17-v3.md`

### è©•ä¾¡æ–‡æ›¸

- åˆå›è©•ä¾¡: `docs/eval-profile-systematic-testing-2025-11-17.md`
- èª¿æ•´æ¯”è¼ƒ: `docs/eval-profile-adjustment-comparison-2025-11-17.md`
- æœ€çµ‚è©•ä¾¡: `docs/eval-profile-optimization-final-2025-11-17.md`ï¼ˆæœ¬æ–‡æ›¸ï¼‰

### ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰

- ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å®šç¾©: `src/server/boost-profiles.ts`
- Variantè¨­å®š: `scripts/assay/kiri-variants.ts`
- ãƒãƒƒãƒã‚¹ã‚¯ãƒªãƒ—ãƒˆ: `scripts/assay/run-profile-matrix.ts`
- ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ: `scripts/assay/report-matrix.ts`

### GitHub Issue

- [Issue #77: ãƒ–ãƒ¼ã‚¹ãƒˆãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®ç³»çµ±çš„ãƒ†ã‚¹ãƒˆ](https://github.com/CAPHTECH/kiri/issues/77)
