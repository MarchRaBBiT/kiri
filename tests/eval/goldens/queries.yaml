schemaVersion: "1.0.0"
datasetVersion: "v2025-11-14-expansion"
description: "Representative queries for KIRI search accuracy evaluation (core + assay-kit hints)"

# デフォルト実行パラメータ
defaultParams:
  k: 10
  tool: "context_bundle"
  boostProfile: "default"
  timeoutMs: 30000

# リポジトリ定義（複数レポの評価をサポート）
defaultRepo: "kiri-core"
repos:
  kiri-core:
    repoPath: "."
    dbPath: "var/index.duckdb"
  assay-kit:
    repoPath: "external/assay-kit"
    dbPath: "external/assay-kit/.kiri/index.duckdb"

# クエリリスト
queries:
  # Bugfix Category
  - id: bugfix-001
    query: "database connection timeout error handling"
    tool: "context_bundle"
    intent: "Investigate database connection issues"
    category: "bugfix"
    expected:
      paths:
        - "src/shared/duckdb.ts"
      patterns:
        - "src/shared/**/*.ts"
    tags: ["database", "error-handling"]
    notes: "Should prioritize DuckDBClient implementation"

  # Feature Category
  - id: feature-001
    query: "context_bundle ranking algorithm implementation"
    tool: "context_bundle"
    intent: "Understand context extraction and ranking logic"
    category: "feature"
    expected:
      paths:
        - "src/server/handlers.ts"
        - "src/server/scoring.ts"
      patterns:
        - "src/server/**/*.ts"
    tags: ["mcp", "search", "ranking"]
    notes: "Should include scoring profile logic"

  # Refactor Category
  - id: refactor-001
    query: "AST symbol extraction tree-sitter"
    tool: "context_bundle"
    intent: "Find symbol extraction logic for refactoring"
    category: "refactor"
    expected:
      paths:
        - "src/indexer/codeintel.ts"
      patterns:
        - "src/indexer/**/*.ts"
    tags: ["indexer", "ast", "codeintel"]
    notes: "Should locate tree-sitter integration points"

  # Infra Category
  - id: infra-001
    query: "scoring profiles configuration boost"
    tool: "files_search"
    intent: "Find boost configuration files"
    category: "infra"
    expected:
      paths:
        - "config/scoring-profiles.yml"
        - "src/server/boost-profiles.ts"
      patterns:
        - "config/**/*.yml"
        - "src/server/boost*.ts"
    tags: ["config", "scoring"]
    notes: "Should use files_search to find config files"

  # Docs Category
  - id: docs-001
    query: "search ranking BM25 algorithm documentation"
    tool: "context_bundle"
    intent: "Find documentation about search algorithms"
    category: "docs"
    params:
      boostProfile: "balanced"
    expected:
      paths:
        - "docs/search-ranking.md"
      patterns:
        - "docs/**/*.md"
    tags: ["docs", "search", "ranking"]
    notes: "Use balanced profile to include docs/ directory"

  # Assay Kit integration queries (private submodule)
  - id: assay-001
    repo: "assay-kit"
    query: "tuning orchestrator parallel trials early stopping"
    tool: "context_bundle"
    intent: "Understand how Assay Kit schedules concurrent hyperparameter trials"
    category: "feature"
    expected:
      paths:
        - "external/assay-kit/src/tuning/orchestrator.ts"
      patterns:
        - "external/assay-kit/src/tuning/**/*.ts"
    tags: ["assay-kit", "tuning", "concurrency"]
    notes: "Should rank the tuning orchestrator that controls parallel trials and early stopping."

  - id: assay-002
    repo: "assay-kit"
    query: "dataset loader manifest hydration pipeline"
    tool: "context_bundle"
    intent: "Locate the dataset loader responsible for manifest hydration"
    category: "feature"
    expected:
      paths:
        - "external/assay-kit/src/dataset/loader.ts"
      patterns:
        - "external/assay-kit/src/dataset/**/*.ts"
    tags: ["assay-kit", "dataset", "loader"]
    notes: "Validates that manifest-based dataset resolution surfaces loader.ts first."

  - id: assay-003
    repo: "assay-kit"
    query: "assay cli evaluate command wiring"
    tool: "context_bundle"
    intent: "Trace how the CLI hooks into evaluation commands"
    category: "infra"
    expected:
      paths:
        - "external/assay-kit/src/cli/commands/evaluate.ts"
      patterns:
        - "external/assay-kit/src/cli/**/*.ts"
    tags: ["assay-kit", "cli", "commands"]
    notes: "Ensures CLI command surface returns the evaluate handler rather than shared utils."

  # === Expanded Query Set (13 additional queries) ===
  # 追加方針:
  # 1. カテゴリ: bugfix 3 / feature 4 / refactor 2 / docs 2 / infra 2 でバランス
  # 2. パターン: content-only・mixed（path+keyword）・path-only を網羅
  # 3. カバレッジ: src/*, tests/*, docs/*, scripts/*, config/* を跨ぐ

  - id: bugfix-002
    query: "resolveRepoId symlink cache invalidation"
    tool: "context_bundle"
    intent: "シンボリックリンク経由で repo ID 解決が化けたケースの原因箇所を特定する"
    category: "bugfix"
    expected:
      paths:
        - "src/server/handlers.ts"
        - "src/server/runtime.ts"
        - "tests/server/resolve-repo.spec.ts"
    tags: ["repo-id", "symlink", "duckdb"]
    rationale: "repo ID キャッシュがずれて検索不能になる障害を再現するため、実装・起動経路・検証を同時に引ける必要がある。"
    notes: "Content-only 複合キーワードで handler 層と runtime 層を横断検索。"

  - id: bugfix-003
    query: "degrade controller fts throttle"
    tool: "context_bundle"
    intent: "FTS 障害時に degradeController がどうスロットルするかを追跡する"
    category: "bugfix"
    expected:
      paths:
        - "src/server/fallbacks/degradeController.ts"
        - "src/server/runtime.ts"
        - "tests/server/degrade.spec.ts"
    tags: ["fts", "fallback", "throttle"]
    rationale: "FTS 拡張が落ちたときの制御を検証する回数が多く、サーバー本体と統合テストの組み合わせが欠かせない。"
    notes: "Content-only クエリで degrade 制御のホットパスを押さえる。"

  - id: bugfix-004
    query: "stale lockfile removal acquireLock"
    tool: "context_bundle"
    intent: "クラッシュ後に残るロックファイルの除去手順を調べる"
    category: "bugfix"
    expected:
      paths:
        - "src/shared/utils/lockfile.ts"
        - "src/indexer/watch.ts"
        - "tests/indexer/watch.spec.ts"
    tags: ["lockfile", "watcher", "concurrency"]
    rationale: "並列インデクサ問題の再発率が高いため、低レイヤーのユーティリティとそれを使うウォッチャー/テストを同時に確認できることが重要。"
    notes: "Content-only クエリで共有ユーティリティと利用箇所を同時に引き当てる。"

  - id: feature-002
    query: "WarningManager breaking change notification"
    tool: "context_bundle"
    intent: "WarningManager がブレイキングチェンジ警告をどう配信するか理解する"
    category: "feature"
    expected:
      paths:
        - "src/server/rpc.ts"
        - "src/server/handlers.ts"
        - "tests/server/context.bundle.spec.ts"
    tags: ["warnings", "rpc", "ux"]
    rationale: "警告配信を改善する際に RPC 層・ハンドラ・テストの流れを把握できる必要がある。"
    notes: "Content-only クエリで WarningManager 実装と利用テストを網羅。"

  - id: feature-003
    query: "deps.closure rpc contract"
    tool: "context_bundle"
    intent: "deps.closure RPC の戻り値や契約を把握する"
    category: "feature"
    expected:
      paths:
        - "src/server/handlers.ts"
        - "tests/server/deps.closure.spec.ts"
        - "docs/api-and-client.md"
    tags: ["deps", "rpc", "api"]
    rationale: "依存グラフ API の互換性を確認する際に、実装・仕様・テストの 3 点セットを同時に参照したい。"
    notes: "Mixed（API 名 + 概念）で仕様書とコードをまとめてヒットさせる。"

  - id: feature-004
    query: "indexBootstrap warm start locking"
    tool: "context_bundle"
    intent: "indexBootstrap がウォームスタート時にどうロックを扱うか把握する"
    category: "feature"
    expected:
      paths:
        - "src/server/indexBootstrap.ts"
        - "src/server/runtime.ts"
        - "tests/server/indexBootstrap.spec.ts"
    tags: ["bootstrap", "locking", "server-startup"]
    rationale: "インデックス再利用時のロック回りを改善する議論で頻出する組み合わせ。"
    notes: "Content-only だが CamelCase を含み、関数名検索の精度を確認。"

  - id: feature-005
    query: "client proxy handshake streams"
    tool: "context_bundle"
    intent: "CLI と Proxy 間のストリーム/ハンドシェイク処理を調査する"
    category: "feature"
    expected:
      paths:
        - "src/client/cli.ts"
        - "src/client/proxy.ts"
        - "docs/api-and-client.md"
    tags: ["cli", "proxy", "handshake"]
    rationale: "クライアント周りの UX を改善する際に CLI 実装とプロキシ層を同時にトレースしたい。"
    notes: "Content-only 複合語で client ディレクトリの網羅性を評価。"

  - id: refactor-002
    query: "normalizeDbPath symlink safe locking"
    tool: "context_bundle"
    intent: "DB パス正規化とロック設計を見直すための実装を探す"
    category: "refactor"
    expected:
      paths:
        - "src/shared/utils/path.ts"
        - "src/indexer/cli.ts"
        - "tests/indexer/path-normalization.spec.ts"
    tags: ["path", "locking", "normalization"]
    rationale: "クロスプラットフォーム対応リファクタではユーティリティ・CLI・テストの整合性が鍵。"
    notes: "Content-only でユーティリティとその利用箇所をまとめて取得。"

  - id: refactor-003
    query: "src/indexer/watch.ts drainBatch backpressure"
    tool: "context_bundle"
    intent: "watcher の drainBatch/backpressure 実装を整理する"
    category: "refactor"
    expected:
      paths:
        - "src/indexer/queue.ts"
        - "src/indexer/watch.ts"
        - "tests/indexer/batch-processing.spec.ts"
    tags: ["queue", "backpressure", "watcher"]
    rationale: "Queue/Watcher の結合部はリファクタ対象になりやすく、混在クエリでパス検索能力を検証したい。"
    notes: "Mixed（ファイルパス + キーワード）で path 断片検索を評価。"

  - id: docs-002
    query: "daemon incident response runbook"
    tool: "context_bundle"
    intent: "デーモン障害時の緊急手順書を素早く開く"
    category: "docs"
    params:
      boostProfile: "balanced"
    expected:
      paths:
        - "docs/runbook.md"
        - "docs/operations.md"
        - "docs/testing.md"
    tags: ["runbook", "daemon", "ops"]
    rationale: "運用手順の確認頻度が高いため、複数ドキュメントを 1 クエリで拾えるようにする。"
    notes: "Content-only 複合語を Balanced プロファイルで評価。"

  - id: docs-003
    query: "docs/security.md zero trust checklist"
    tool: "context_bundle"
    intent: "セキュリティ基準と設定テンプレートを見比べる"
    category: "docs"
    params:
      boostProfile: "balanced"
    expected:
      paths:
        - "docs/security.md"
        - "docs/processes/security-review.md"
        - "config/security.yml"
    tags: ["security", "policy", "config"]
    rationale: "ドキュメントと実際の設定ファイルを同時に参照するレビューが多い。"
    notes: "Mixed（ファイル名 + コンセプト）で docs/config の横断検索を評価。"

  - id: infra-002
    query: "scripts/update-deps.ts provenance verification"
    tool: "context_bundle"
    intent: "依存更新スクリプトの署名検証フローを追う"
    category: "infra"
    expected:
      paths:
        - "scripts/update-deps.ts"
        - "scripts/diag.ts"
        - "config/default.example.yml"
    tags: ["deps", "scripts", "supply-chain"]
    rationale: "依存アップデート時のセキュリティ確認を高速に行うため、関連スクリプトと設定を即時に引きたい。"
    notes: "Content-only クエリで scripts 配下と config を同時に取得。"

  - id: infra-003
    query: "scripts/audit/export-log.ts"
    tool: "files_search"
    intent: "監査ログエクスポートスクリプトをパス指定で即開く"
    category: "infra"
    expected:
      paths:
        - "scripts/audit/export-log.ts"
        - "tests/server/audit.spec.ts"
        - "docs/operations.md"
    tags: ["audit", "logging", "ops"]
    rationale: "ログエクスポートの改修ではスクリプト・テスト・運用ドキュメントを一度にチェックしたい。"
    notes: "Path-only クエリで files_search の精度とフォールバック挙動を確認。"

  # Assay-kit coverage (metadata hints を含むクエリ)
  - id: assay-cli-main
    query: "assay-kit cli main entrypoint command routing"
    tool: "context_bundle"
    intent: "CLI エントリーポイントとコマンド登録の経路を把握する"
    category: "cli"
    repo: "assay-kit"
    hints:
      - "runCli"
      - "registerCommands"
      - "external/assay-kit/src/cli/main.ts"
    expected:
      paths:
        - "external/assay-kit/src/cli/main.ts"
        - "external/assay-kit/src/cli/commands/types.ts"
    tags: ["cli", "commands"]
    rationale: "CLI 改修時にメイン処理とコマンド定義を同時に開けるかを検証。"
    notes: "Hint 経由で CLI のブートストラップを優先表示できるかを確認。"

  - id: assay-cli-compare
    query: "compare command diff reporter"
    tool: "context_bundle"
    intent: "比較コマンドと差分レポーターの実装を辿る"
    category: "cli"
    repo: "assay-kit"
    hints:
      - "executeCompareCommand"
      - "ComparisonReporter"
      - "external/assay-kit/src/cli/commands/compare.ts"
    expected:
      paths:
        - "external/assay-kit/src/cli/commands/compare.ts"
        - "external/assay-kit/src/runner/comparison.ts"
    tags: ["cli", "compare"]
    rationale: "差分比較 UX を調整する際に CLI・runner を一気に参照したい。"
    notes: "Hint が無いと CLI 以外が優先されやすいため重み付けを評価。"

  - id: assay-baseline
    query: "baseline loader filesystem snapshot"
    tool: "context_bundle"
    intent: "ファイルシステムベースラインの読込処理を把握する"
    category: "baseline"
    repo: "assay-kit"
    hints:
      - "FilesystemBaselineSource"
      - "loadBaselineRun"
      - "external/assay-kit/src/baseline/filesystem.ts"
    expected:
      paths:
        - "external/assay-kit/src/baseline/filesystem.ts"
        - "external/assay-kit/src/baseline/index.ts"
    tags: ["baseline", "filesystem"]
    rationale: "比較結果の保存形式を確認するクエリを追加し、抽象語でも着地点を保証。"
    notes: "Hint の有無で runner 側ではなく baseline を返すかを評価。"

  - id: assay-plugin-logger
    query: "plugin lifecycle logging hooks"
    tool: "context_bundle"
    intent: "プラグインのライフサイクルログ処理を確認する"
    category: "plugins"
    repo: "assay-kit"
    hints:
      - "PluginLogger"
      - "logPluginLifecycle"
      - "external/assay-kit/src/plugins/logger.ts"
    expected:
      paths:
        - "external/assay-kit/src/plugins/logger.ts"
        - "external/assay-kit/src/plugins/registry.ts"
    tags: ["plugins", "logging"]
    rationale: "プラグイン登録とロガーをまたぐトレースが必要なケースを再現。"
    notes: "Hint により logger.ts をリスト上位へ固定できるかを検証。"

  - id: assay-plugin-deps
    query: "plugin dependency resolver validation"
    tool: "context_bundle"
    intent: "プラグイン依存関係の解決・検証フローを読む"
    category: "plugins"
    repo: "assay-kit"
    hints:
      - "resolvePluginDependencies"
      - "DependencyValidationError"
      - "external/assay-kit/src/plugins/dependencies.ts"
    expected:
      paths:
        - "external/assay-kit/src/plugins/dependencies.ts"
        - "external/assay-kit/src/plugins/types.ts"
    tags: ["plugins", "dependencies"]
    rationale: "依存解決コードへ確実に辿れるかを評価し、型定義との同時表示も狙う。"
    notes: "Hint により dependencies.ts の優先度を底上げ。"

  - id: assay-runner-analysis
    query: "statistical analyzer significance detection"
    tool: "context_bundle"
    intent: "統計アナライザーの有意性判定ロジックを追う"
    category: "runner"
    repo: "assay-kit"
    hints:
      - "StatisticalAnalyzer"
      - "analyzeSignificance"
      - "external/assay-kit/src/runner/statistical-analyzer.ts"
    expected:
      paths:
        - "external/assay-kit/src/runner/statistical-analyzer.ts"
        - "external/assay-kit/src/runner/comparison-types.ts"
    tags: ["runner", "statistics"]
    rationale: "A/B 検証の判定ロジックを明示的に引き当てたいケースを評価。"
    notes: "Hint がある状態で比較エンジンを先頭に表示できるか。"

  - id: assay-runner-summary
    query: "comparison summary builder rows"
    tool: "context_bundle"
    intent: "比較結果サマリー生成処理を確認する"
    category: "runner"
    repo: "assay-kit"
    hints:
      - "buildComparisonSummary"
      - "SummaryRow"
      - "external/assay-kit/src/runner/summary.ts"
    expected:
      paths:
        - "external/assay-kit/src/runner/summary.ts"
        - "external/assay-kit/src/runner/index.ts"
    tags: ["runner", "summary"]
    rationale: "集計ビューの見直し時に summary 実装へ確実に導きたい。"
    notes: "Hint により summary.ts を runner/index.ts より前に出せるか。"

  - id: assay-metrics-latency
    query: "latency metric percentile calculation"
    tool: "context_bundle"
    intent: "LAT 指標の算出処理をチェックする"
    category: "metrics"
    repo: "assay-kit"
    hints:
      - "LatencyMetric"
      - "computeLatencyStats"
      - "external/assay-kit/src/metrics/latency.ts"
    expected:
      paths:
        - "external/assay-kit/src/metrics/latency.ts"
        - "external/assay-kit/src/metrics/index.ts"
    tags: ["metrics", "latency"]
    rationale: "遅延メトリクス改善時に該当ファイルへ即到達するかを測定。"
    notes: "Hint を渡して latency.ts をランキング上位へ固定。"

  - id: assay-metrics-ranking
    query: "ranking metrics ndcg precision"
    tool: "context_bundle"
    intent: "ランキング指標（NDCG 等）の実装を把握する"
    category: "metrics"
    repo: "assay-kit"
    hints:
      - "RankingMetric"
      - "dcg"
      - "external/assay-kit/src/metrics/ranking.ts"
    expected:
      paths:
        - "external/assay-kit/src/metrics/ranking.ts"
        - "external/assay-kit/src/metrics/combined.ts"
    tags: ["metrics", "ranking"]
    rationale: "NDCG 周辺のロジックを確実に返せるかを評価。"
    notes: "Hint による ranking.ts のブースト効果を検証。"

  - id: assay-utils-glob
    query: "glob matcher utility double star"
    tool: "context_bundle"
    intent: "Glob ユーティリティの ** 対応ロジックを調べる"
    category: "utils"
    repo: "assay-kit"
    hints:
      - "matchGlob"
      - "GlobPattern"
      - "external/assay-kit/src/utils/glob.ts"
    expected:
      paths:
        - "external/assay-kit/src/utils/glob.ts"
        - "external/assay-kit/src/utils/index.ts"
    tags: ["utils", "glob"]
    rationale: "抽象語のみでも glob.ts を返せるかを確認。"
    notes: "Hint でユーティリティ層を上位へ誘導。"

  - id: assay-errors-timeout
    query: "timeout error retry classification"
    tool: "context_bundle"
    intent: "タイムアウトエラー分類と再試行判定を読む"
    category: "errors"
    repo: "assay-kit"
    hints:
      - "TimeoutError"
      - "retryable"
      - "external/assay-kit/src/errors/timeout-error.ts"
    expected:
      paths:
        - "external/assay-kit/src/errors/timeout-error.ts"
        - "external/assay-kit/src/errors/index.ts"
    tags: ["errors", "timeouts"]
    rationale: "エラー分類改善時に該当ファイルへ直行したい。"
    notes: "Hint により timeout-error.ts がトップに出るかを確認。"

  - id: assay-types-query
    query: "assay query metadata tags"
    tool: "context_bundle"
    intent: "クエリ型定義とメタデータ構造を参照する"
    category: "types"
    repo: "assay-kit"
    hints:
      - "AssayQuery"
      - "QueryMetadata"
      - "external/assay-kit/src/types/query.ts"
    expected:
      paths:
        - "external/assay-kit/src/types/query.ts"
        - "external/assay-kit/src/types/index.ts"
    tags: ["types", "query"]
    rationale: "型追加時に query.ts を即時に開けるよう評価。"
    notes: "Hint で types/ 配下を優先させるケース。"

  - id: assay-types-dataset
    query: "dataset definition schema types"
    tool: "context_bundle"
    intent: "データセット定義の型を確認する"
    category: "types"
    repo: "assay-kit"
    hints:
      - "DatasetDefinition"
      - "QueryResultRow"
      - "external/assay-kit/src/types/dataset.ts"
    expected:
      paths:
        - "external/assay-kit/src/types/dataset.ts"
        - "external/assay-kit/src/types/index.ts"
    tags: ["types", "dataset"]
    rationale: "スキーマ追加時に対象ファイルへ誘導できるかを評価。"
    notes: "Hint で dataset.ts を先行表示。"

  - id: assay-reporting-json
    query: "json reporter emit artifacts"
    tool: "context_bundle"
    intent: "JSON レポーターの出力処理を把握する"
    category: "reporter"
    repo: "assay-kit"
    hints:
      - "JsonReporter"
      - "writeJsonReport"
      - "external/assay-kit/src/reporting/json.ts"
    expected:
      paths:
        - "external/assay-kit/src/reporting/json.ts"
        - "external/assay-kit/src/reporting/index.ts"
    tags: ["reporter", "json"]
    rationale: "レポート出力周りの改善で JSON 実装へ素早くアクセスしたい。"
    notes: "Hint のブーストを評価し、reporting/json.ts を確実に返させる。"
