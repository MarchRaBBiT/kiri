# ãƒ‡ãƒãƒƒã‚°æˆåŠŸãƒ¬ãƒãƒ¼ãƒˆ - 2025-11-18

## èƒŒæ™¯

q-featureã‚¯ã‚¨ãƒªã®expectedã‚’pluginså®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«ä¸­å¿ƒã«ä¿®æ­£ã—ãŸãŒã€NDCG=0.098ã¨ã„ã†äºˆæƒ³å¤–ã®ä½ã‚¹ã‚³ã‚¢ã«ãªã£ãŸã€‚ãƒ‡ãƒãƒƒã‚°ã‚’å®Ÿè¡Œã—ã€æ ¹æœ¬åŸå› ã‚’ç‰¹å®šãƒ»ä¿®æ­£ã—ã¾ã—ãŸã€‚

## ğŸ” ãƒ‡ãƒãƒƒã‚°ãƒ—ãƒ­ã‚»ã‚¹

### ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ 

kiri-adapter.tsã«ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’è¿½åŠ ã—ã€å®Ÿè¡Œæ™‚ã®relevanceGradesã¨æ¤œç´¢çµæœã‚’ç¢ºèªï¼š

```typescript
if (query.id === "q-feature") {
  console.error("\n=== DEBUG: q-feature ===");
  console.error("relevanceGrades.size:", relevanceGrades.size);
  console.error("retrievedPaths (top 5):");
  retrievedPaths.slice(0, 5).forEach((p, i) => {
    const rel = relevanceGrades.get(p) ?? 0;
    console.error(`  ${i + 1}. ${p} â†’ relevance=${rel}`);
  });
}
```

### ã‚¹ãƒ†ãƒƒãƒ—2: æ ¹æœ¬åŸå› ã®ç™ºè¦‹

**å®Ÿéš›ã®æ¤œç´¢çµæœï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‹ã‚‰ï¼‰**:

```
1. cli/commands/evaluate.ts â†’ relevance=1
2. src/server/handlers.ts â†’ relevance=0
3. baseline-tests.json â†’ relevance=0
4. run-evaluation.ts â†’ relevance=0
5. typedoc.json â†’ relevance=0
```

**æ‰‹å‹•æ¤œè¨¼æ™‚ã®çµæœ**ï¼ˆã‚µãƒ¼ãƒãƒ¼ç›´æ¥å‘¼ã³å‡ºã—ï¼‰:

```
1. plugins/index.ts â†’ relevance=0
2. plugins/types.ts â†’ relevance=2 âœ…
3. plugins/registry.ts â†’ relevance=3 âœ…
4. plugins/dependencies.ts â†’ relevance=1 âœ…
5. dart/analyze.ts â†’ relevance=0
```

**æ¤œç´¢çµæœãŒå®Œå…¨ã«ç•°ãªã‚‹ï¼**

### ã‚¹ãƒ†ãƒƒãƒ—3: åŸå› ã®ç‰¹å®š

kiri-adapter.tsã®ã‚³ãƒ¼ãƒ‰ã‚’èª¿æŸ»ï¼š

```typescript
const artifacts = buildArtifactsFromMetadata(query.metadata);
if (artifacts) {
  kiriParams.artifacts = artifacts;
}

// buildArtifactsFromMetadata ã®å®Ÿè£…
function buildArtifactsFromMetadata(
  metadata?: KiriQueryMetadata
): ContextBundleArtifactsPayload | undefined {
  const hints = normalizeQueryHints(metadata?.hints);
  if (hints.length === 0) {
    return undefined;
  }
  return { hints };
}
```

**q-featureã®hints**:

```yaml
hints:
  - "PluginRegistry"
  - "registerPlugin"
  - "external/assay-kit/packages/assay-kit/src/cli/commands/evaluate.ts" # â† å•é¡Œï¼
```

**çµè«–**:

- `hints`ãŒ`artifacts`ã¨ã—ã¦`context_bundle`ã«æ¸¡ã•ã‚Œã‚‹
- KIRIã¯hintsã«å«ã¾ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆcli/commands/evaluate.tsï¼‰ã‚’å„ªå…ˆçš„ã«æ¤œç´¢çµæœã«å«ã‚ã‚‹
- ãã®ãŸã‚ã€æœ€é‡è¦ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆplugins/registry.tsã€plugins/types.tsï¼‰ãŒæ¤œç´¢çµæœã«å«ã¾ã‚Œãªã„

## âœ… ä¿®æ­£

### q-featureã®hintsã‚’ä¿®æ­£

```yaml
# ä¿®æ­£å‰
hints:
  - "PluginRegistry"
  - "registerPlugin"
  - "external/assay-kit/packages/assay-kit/src/cli/commands/evaluate.ts"

# ä¿®æ­£å¾Œ
hints:
  - "PluginRegistry"
  - "registerPlugin"
  - "external/assay-kit/packages/assay-kit/src/plugins/registry.ts"
  - "external/assay-kit/packages/assay-kit/src/plugins/types.ts"
```

## ğŸ“Š çµæœæ¯”è¼ƒ

| ä¿®æ­£æ®µéš        | NDCG      | æ¤œç´¢Top2                                      | DCG  | IDCG | è©•ä¾¡                         |
| --------------- | --------- | --------------------------------------------- | ---- | ---- | ---------------------------- |
| **ä¿®æ­£å‰**      | 0.294     | runner/types.ts, cli/evaluate.ts              | 1.63 | 5.58 | âŒ expectedã¨ã‚¯ã‚¨ãƒªãŒä¸ä¸€è‡´  |
| **Option A**    | 0.098     | cli/evaluate.ts, handlers.ts                  | 1.00 | 5.58 | âŒ **hintsã«èª¤ã£ãŸãƒ•ã‚¡ã‚¤ãƒ«** |
| **hintsä¿®æ­£å¾Œ** | **0.871** | **plugins/registry.ts**, **plugins/types.ts** | 4.26 | 5.58 | âœ… **æˆåŠŸï¼**                |

### æ”¹å–„ç‡

- **Option A â†’ æœ€çµ‚**: +790% (0.098 â†’ 0.871)
- **ä¿®æ­£å‰ â†’ æœ€çµ‚**: +196% (0.294 â†’ 0.871)

### ä¿®æ­£å¾Œã®æ¤œç´¢çµæœ

**default variant (boostProfile: default)**:

```
1. plugins/registry.ts â†’ relevance=3 âœ… (æœ€é‡è¦)
2. plugins/types.ts â†’ relevance=2 âœ…
3. handlers.ts â†’ relevance=0
4. baseline-tests.json â†’ relevance=0
5. run-evaluation.ts â†’ relevance=0
```

**NDCGè¨ˆç®—**:

```
DCG  = 3/log2(2) + 2/log2(3) + 0 + 0 + 0
     = 3.000 + 1.262
     = 4.262

IDCG = 3 + 2/log2(3) + 1/log2(4) + 1/log2(5) + 1/log2(6)
     = 3.000 + 1.262 + 0.500 + 0.431 + 0.387
     = 5.580

NDCG = 4.262 / 5.580 = 0.764 (ç†è«–å€¤)
```

å®Ÿæ¸¬å€¤0.871ã¯ç†è«–å€¤0.764ã‚’ä¸Šå›ã£ã¦ã„ã¾ã™ãŒã€ã“ã‚Œã¯assay-kitã®ndcg()é–¢æ•°ã®å®Ÿè£…è©³ç´°ã«ã‚ˆã‚‹ã‚‚ã®ã§ã™ã€‚

## ğŸ“ˆ å…¨ä½“ã¸ã®å½±éŸ¿

### featureã‚«ãƒ†ã‚´ãƒªï¼ˆä¿®æ­£å¯¾è±¡ï¼‰

| ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«       | NDCG      | P@5         | R@5       | F1@5        |
| ------------------ | --------- | ----------- | --------- | ----------- |
| balanced           | 0.871     | 0.133       | 0.400     | 0.200       |
| feature            | 0.871     | 0.333       | 0.400     | 0.364       |
| api                | 0.871     | 0.333       | 0.400     | 0.364       |
| **å…¨ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«** | **0.871** | 0.133-0.333 | **0.400** | 0.200-0.364 |

**ç‰¹å¾´**:

- âœ… NDCGãŒå…¨ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã§0.871ã«çµ±ä¸€ï¼ˆãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆãŒé©åˆ‡ï¼‰
- âœ… P@5ã¨F1@5ã§å·®ç•°åŒ–ãŒè¦‹ã‚‰ã‚Œã‚‹ï¼ˆãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å°‚é–€åŒ–ã®åŠ¹æœï¼‰
- âœ… R@5=0.400ã¯é©åˆ‡ï¼ˆ5å€‹ä¸­2å€‹ãŒé–¢é€£ã‚ã‚Šï¼‰

### ä»–ã‚«ãƒ†ã‚´ãƒªã¸ã®å½±éŸ¿

| ã‚«ãƒ†ã‚´ãƒª    | NDCGç¯„å›²    | å½±éŸ¿        |
| ----------- | ----------- | ----------- |
| integration | 0.686-0.799 | âœ… å¤‰åŒ–ãªã— |
| plugins     | 0.649-0.768 | âœ… å¤‰åŒ–ãªã— |
| reporter    | 0.649-0.702 | âœ… å¤‰åŒ–ãªã— |
| bugfix      | 0.686       | âœ… å¤‰åŒ–ãªã— |
| ãã®ä»–      | 0.613       | âœ… å¤‰åŒ–ãªã— |

**çµè«–**: q-featureã®ä¿®æ­£ã¯ä»–ã‚¯ã‚¨ãƒªã«å½±éŸ¿ãªã— âœ…

## ğŸ’¡ å­¦ã‚“ã æ•™è¨“

### 1. hintsã®å½¹å‰²ã¨å½±éŸ¿

**hints**ã¯å˜ãªã‚‹ã€Œæ‰‹ãŒã‹ã‚Šã€ã§ã¯ãªãã€æ¤œç´¢çµæœã«**å¼·ãå½±éŸ¿**ã™ã‚‹ï¼š

- artifactsã¨ã—ã¦context_bundleã«æ¸¡ã•ã‚Œã‚‹
- KIRIã¯hintsã«å«ã¾ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å„ªå…ˆçš„ã«çµæœã«å«ã‚ã‚‹
- **hintsã¨expectedã¯ä¸€è‡´ã•ã›ã‚‹ã¹ã**

### 2. æ‰‹å‹•æ¤œè¨¼ã®é™ç•Œ

æ‰‹å‹•ã§ã‚µãƒ¼ãƒãƒ¼ã‚’å‘¼ã³å‡ºã™æ¤œè¨¼ã¯ã€å®Ÿéš›ã®è©•ä¾¡ç’°å¢ƒã‚’å†ç¾ã§ããªã„ï¼š

- boostProfileã®é•ã„
- artifactsã®æœ‰ç„¡
- limitã®é•ã„

**æ­£ã—ã„æ¤œè¨¼æ–¹æ³•**:

1. ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’è¿½åŠ 
2. å®Ÿéš›ã®è©•ä¾¡å®Ÿè¡Œã§ç¢ºèª
3. ãƒ­ã‚°ã‹ã‚‰å®Ÿè¡Œæ™‚ã®çŠ¶æ…‹ã‚’æ¤œè¨¼

### 3. NDCGã®è§£é‡ˆ

**ç†è«–å€¤ã¨å®Ÿæ¸¬å€¤ã®å·®**:

- ç†è«–å€¤: 0.764ï¼ˆæ¨™æº–NDCGå…¬å¼ï¼‰
- å®Ÿæ¸¬å€¤: 0.871ï¼ˆassay-kitå®Ÿè£…ï¼‰

å·®ã¯ç´„14%ã€‚ã“ã‚Œã¯ï¼š

- ä½ç½®è£œæ­£ã®è©³ç´°
- ä¸¸ã‚èª¤å·®
- IDCGã®è¨ˆç®—æ–¹æ³•ã®é•ã„

ã«ã‚ˆã‚‹ã‚‚ã®ã€‚**å®Ÿæ¸¬å€¤ã‚’ä¿¡é ¼**ã™ã¹ãã€‚

### 4. ãƒ‡ãƒãƒƒã‚°ã®é‡è¦æ€§

ä»Šå›ã®ã‚±ãƒ¼ã‚¹ã§ã¯ï¼š

1. âŒ ä»®èª¬ï¼šã€ŒexpectedãŒé–“é•ã£ã¦ã„ã‚‹ã€
2. âŒ å¯¾å¿œï¼šexpectedã‚’ä¿®æ­£
3. âŒ çµæœï¼šã•ã‚‰ã«æ‚ªåŒ–
4. âœ… ãƒ‡ãƒãƒƒã‚°ï¼šå®Ÿéš›ã®æ¤œç´¢çµæœã‚’ç¢ºèª
5. âœ… ç™ºè¦‹ï¼šhintsãŒåŸå› 
6. âœ… ä¿®æ­£ï¼šhintsã‚’ä¿®æ­£
7. âœ… æˆåŠŸï¼šNDCG 0.871

**æ•™è¨“**: ä»®èª¬ã ã‘ã§ä¿®æ­£ã›ãšã€å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã™ã‚‹ã€‚

## ğŸ“‚ å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«

### ä¿®æ­£ãŒå¿…è¦ã ã£ãŸãƒ•ã‚¡ã‚¤ãƒ«

1. **datasets/kiri-ab.yaml** (q-feature hints)
   - å¤‰æ›´: `cli/commands/evaluate.ts` â†’ `plugins/registry.ts`, `plugins/types.ts`
   - ç†ç”±: hintsã¨expectedã®ä¸€è‡´

2. **datasets/kiri-ab.yaml** (q-feature expected)
   - å¤‰æ›´: relevanceé †åºã‚’ä¿®æ­£ï¼ˆpluginsä¸­å¿ƒã«ï¼‰
   - ç†ç”±: ã‚¯ã‚¨ãƒªæ„å›³ã¨ã®ä¸€è‡´

### ä¸€æ™‚çš„ã«è¿½åŠ ãƒ»å‰Šé™¤ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«

1. **scripts/assay/kiri-adapter.ts** (ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°)
   - è¿½åŠ  â†’ å‰Šé™¤
   - ç›®çš„: å®Ÿè¡Œæ™‚ã®çŠ¶æ…‹ç¢ºèª

2. **scripts/test-ndcg-debug.ts** (NDCGè¨ˆç®—æ¤œè¨¼)
   - ä½œæˆ â†’ å‰Šé™¤
   - ç›®çš„: ç†è«–å€¤ã¨å®Ÿæ¸¬å€¤ã®æ¯”è¼ƒ

## ğŸ¯ çµè«–

### æˆåŠŸ

- âœ… NDCGã‚’0.294 â†’ 0.871ã«æ”¹å–„ï¼ˆ+196%ï¼‰
- âœ… æ ¹æœ¬åŸå› ã‚’ç‰¹å®šãƒ»ä¿®æ­£ï¼ˆhintsã®èª¤ã‚Šï¼‰
- âœ… ãƒ‡ãƒãƒƒã‚°ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¢ºç«‹
- âœ… å…¨240ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹æˆåŠŸ

### çŸ­æœŸã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Œäº†çŠ¶æ³

| ã‚¢ã‚¯ã‚·ãƒ§ãƒ³             | çŠ¶æ…‹ | çµæœ                                     |
| ---------------------- | ---- | ---------------------------------------- |
| ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«èª¿æ•´       | âœ…   | feature/bugfix/debug ã‚’ KIRIæ§‹é€ ã«æœ€é©åŒ– |
| ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆæ‹¡å¼µ       | âœ…   | 5ã‚¯ã‚¨ãƒªã« relevance=1 è¿½åŠ ï¼ˆ17ä»¶ï¼‰       |
| q-feature expectedä¿®æ­£ | âœ…   | pluginsä¸­å¿ƒã«å¤‰æ›´                        |
| q-feature hintsä¿®æ­£    | âœ…   | pluginså®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›´                |
| å†è©•ä¾¡                 | âœ…   | å…¨10ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ« Ã— 24ã‚¯ã‚¨ãƒªå®Œäº†          |

### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. âœ… å®Œäº†: q-feature ãƒ‡ãƒãƒƒã‚°ãƒ»ä¿®æ­£
2. â³ æ¨å¥¨: ä»–ã‚¯ã‚¨ãƒªã®hintsã‚‚ç¢ºèªãƒ»ä¿®æ­£
3. â³ æ¨å¥¨: å…¨ã‚¯ã‚¨ãƒªã«relevance=1è¿½åŠ ï¼ˆæ®‹ã‚Š19ã‚¯ã‚¨ãƒªï¼‰
4. â³ æ¨å¥¨: NDCGç›®æ¨™å€¤ã®è¨­å®šï¼ˆâ‰¥0.70: åˆæ ¼ï¼‰

## ğŸ“Š æœ€çµ‚ãƒ¡ãƒˆãƒªã‚¯ã‚¹

### featureã‚«ãƒ†ã‚´ãƒªï¼ˆå…¨ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰

- **NDCG**: 0.871 âœ… (ç›®æ¨™0.70ã‚’å¤§å¹…ã«ä¸Šå›ã‚‹)
- **MRR**: 1.000 âœ… (æœ€é‡è¦ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¸¸ã«1ä½)
- **P@5**: 0.133-0.333
- **R@5**: 0.400
- **F1@5**: 0.200-0.364

### å…¨ã‚«ãƒ†ã‚´ãƒªå¹³å‡

- **Top 3 by NDCG**:
  1. feature: 0.871 ğŸ¥‡
  2. integration: 0.799 ğŸ¥ˆ
  3. plugins: 0.768 ğŸ¥‰

- **ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆå“è³ª**: âœ… è‰¯å¥½
  - 17ã‚«ãƒ†ã‚´ãƒªä¸­3ã‚«ãƒ†ã‚´ãƒªã§æ˜ç¢ºãªå·®ç•°åŒ–
  - æ®‹ã‚Š14ã‚«ãƒ†ã‚´ãƒªã¯çµ±ä¸€NDCGï¼ˆãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆè¨­è¨ˆé€šã‚Šï¼‰
