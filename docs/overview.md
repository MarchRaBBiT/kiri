# KIRI 概要

## 基本情報

- **バージョン**: v0.1 (Draft)
- **更新日**: 2025-10-28
- **オーナー**: りずさん
- **目的**: Git ワークツリーの構造・履歴・近接・意味を合成し、LLM 向けに最小限の文脈断片を即時返却するプラットフォームを構築する。

## 用語

- **Indexer**: Git ワークツリーを走査して DuckDB に書き込む取り込みプロセス。
- **MCP Server**: KIRI の検索機能を MCP（JSON-RPC over stdio/HTTP）ツールとして提供するサーバー。
- **Client**: Codex CLI など MCP ツールを呼び出すクライアント。
- **断片（Snippet）**: 関数やクラスなど意味境界に沿って抽出した行範囲。

## 目標と非目標

### 目標

- **P@10 ≥ 0.7**: 上位 10 断片中 7 つ以上が実務で有用。
- **TTFU ≤ 1.0s**: ローカル実行で初回有用断片を 1 秒以内に返却。
- **Token 削減 ≥ 40%**: 従来の貼り付け方式と比較してプロンプトトークンを 40%以上削減。
- **Degrade 運転**: FTS/VSS 拡張なしでも文字列＋構造近接検索で稼働。

### 非目標

- IDE の完全代替や自動リファクタリング等の包括的コードインサイト。
- リポジトリ横断の厳密なコールグラフ生成（近似で十分）。

## 全体アーキテクチャ

```
+--------------------+     +-----------------------------+     +--------------------+
|     MCP Client     |<--->|  KIRI MCP Server (JSON-RPC) |<--->|      DuckDB        |
| (Codex CLI, etc.)  |     |  tools: search/bundle/...   |     |  index.duckdb      |
+--------------------+     +-----------------------------+     +--------------------+
                                   ^
                                   |
                         +---------+----------+
                         |      Indexer      |
                         |  git scan / AST   |
                         |  embedding (opt)  |
                         +-------------------+
```

- **Indexer** が Git から構造・履歴・本文・埋め込みを DuckDB に書き込む。
- **MCP Server** が DuckDB を叩き、`files.search` や `context.bundle` などのツールを公開する。
- **Client** は `context.bundle` で得た断片を LLM プロンプトへ注入する。
